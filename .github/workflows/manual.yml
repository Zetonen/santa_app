name: üê≥ Docker Build and Push (Next.js Frontend)

# 1. –î–æ–∑–≤–æ–ª–∏: —á–∏—Ç–∞–Ω–Ω—è –∫–æ–¥—É —Ç–∞ –∑–∞–ø–∏—Å —É —Ä–µ—î—Å—Ç—Ä (–¥–ª—è push)
permissions:
  contents: read
  packages: write
  # –ù–µ–æ–±—Ö—ñ–¥–Ω–æ, —è–∫—â–æ –≤–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç–µ —Å–∞–º–æ—Å—Ç—ñ–π–Ω–∏–π runner, –∞–ª–µ –¥–ª—è public/GitHub Registry –Ω–µ –æ–±–æ–≤'—è–∑–∫–æ–≤–æ
  # id-token: write 

on:
  # –ó–∞–ø—É—Å–∫–∞—î–º–æ –≤—Ä—É—á–Ω—É –∑ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—é –≤–∫–∞–∑–∞—Ç–∏ —Ç–µ–≥
  workflow_dispatch:
    inputs:
      tag:
        description: 'Docker Image Tag (e.g., v1.0.0 or latest)'
        required: true
        default: 'latest'
        type: string
  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –∑–∞–ø—É—Å–∫ –ø—Ä–∏ –æ–±'—î–¥–Ω–∞–Ω–Ω—ñ —É –≥—ñ–ª–∫—É 'main'
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    env:
      # –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–º—ñ–Ω–Ω–∏—Ö –æ—Ç–æ—á–µ–Ω–Ω—è
      DOCKER_IMAGE_NAME: olk005430/santa-app
      # –§–∞–∫—Ç–∏—á–Ω–∏–π –ø–æ—Ä—Ç, –Ω–∞ —è–∫–æ–º—É –∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è Next.js —É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ
      PORT: 3001
      
    steps:
    
    # 1. –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∫–æ–¥ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2. –í—Ö—ñ–¥ —É Docker Hub
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.is_token_for_docker_hub }} # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ —Å–≤—ñ–π –∞–∫—Ç—É–∞–ª—å–Ω–∏–π —Å–µ–∫—Ä–µ—Ç
        
    # 3. –§–æ—Ä–º—É—î–º–æ –ø–æ–≤–Ω–∏–π —Ç–µ–≥ –æ–±—Ä–∞–∑—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, olk005430/santa:v1.0.0)
    - name: Prepare Image Tag
      id: prepare_tag
      run: |
        # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Ç–µ–≥ –∑ —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥—É –∞–±–æ —Ñ—ñ–∫—Å–æ–≤–∞–Ω–∏–π —Ç–µ–≥ 'latest' –¥–ª—è push
        TAG=${{ github.event.inputs.tag || 'latest' }}
        IMAGE_TAG=${{ env.DOCKER_IMAGE_NAME }}:${{ TAG }}
        echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

    # 4. –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è Node.js —Ç–∞ –∫–µ—à—É–≤–∞–Ω–Ω—è
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm' # –ö–µ—à—É—î–º–æ npm –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ

    # 5. –ó–±—ñ—Ä–∫–∞ —Ç–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –æ–±—Ä–∞–∑—É
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ steps.prepare_tag.outputs.image_tag }}
        # –ü–µ—Ä–µ–¥–∞—á–∞ –ø–æ—Ä—Ç—É —è–∫ –∞—Ä–≥—É–º–µ–Ω—Ç APP_PORT
        build-args: |
          APP_PORT=${{ env.PORT }}
