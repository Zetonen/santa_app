name: üê≥ Docker Build and Push (Next.js Frontend)

# 1. –ù–∞–¥–∞—î–º–æ –¥–æ–∑–≤–æ–ª–∏ GITHUB_TOKEN –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ —Ä–µ–≥—ñ—Å—Ç—Ä–∞–º–∏
permissions:
  contents: read # –î–æ–∑–≤–æ–ª—è—î —á–∏—Ç–∞—Ç–∏ –∫–æ–¥ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é
  packages: write # –ü–æ—Ç—Ä—ñ–±–µ–Ω –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–Ω–∏–º–∏ —Ä–µ–≥—ñ—Å—Ç—Ä–∞–º–∏ (Docker Hub)

on:
  # –†—É—á–Ω–∏–π –∑–∞–ø—É—Å–∫ –∑ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—é –≤–∫–∞–∑–∞—Ç–∏ —Ç–µ–≥
  workflow_dispatch:
    inputs:
      tag:
        description: 'Docker Image Tag (e.g., v1.0.0 or latest)'
        required: true
        default: 'latest'
        type: string
  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –∑–∞–ø—É—Å–∫ –ø—Ä–∏ –æ–±'—î–¥–Ω–∞–Ω–Ω—ñ –∞–±–æ push —É –≥—ñ–ª–∫—É 'main'
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    env:
      # –í–∞—à–µ —ñ–º'—è –≤ Docker Hub —Ç–∞ –Ω–∞–∑–≤–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é
      DOCKER_IMAGE_NAME: olk005430/santa-app
      
    steps:
    
    # 2. –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∫–æ–¥ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é
    - name: Checkout repository
      uses: actions/checkout@v4

    # 3. –í—Ö—ñ–¥ —É Docker Hub –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –°–µ–∫—Ä–µ—Ç—ñ–≤
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_TOKEN }} # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –∫–æ—Ä–µ–∫—Ç–Ω–µ —ñ–º'—è —Å–µ–∫—Ä–µ—Ç—É

    # 4. –§–æ—Ä–º—É—î–º–æ –ø–æ–≤–Ω–∏–π —Ç–µ–≥ –æ–±—Ä–∞–∑—É (–≤–∏–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å bash/expressions)
    - name: Prepare Image Tag
      id: prepare_tag
      run: |
        # –í–∏–∑–Ω–∞—á–∞—î–º–æ —Ç–µ–≥, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ –≤–≤–µ–¥–µ–Ω–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º input (–∞–±–æ 'latest' –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º)
        TAG="${{ github.event.inputs.tag || 'latest' }}"
        
        # –°—Ç–≤–æ—Ä—é—î–º–æ –ø–æ–≤–Ω–∏–π —Ç–µ–≥ –æ–±—Ä–∞–∑—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, olk005430/santa-app:latest)
        FULL_IMAGE_TAG="${{ env.DOCKER_IMAGE_NAME }}:$TAG"
        
        # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —è–∫ –≤–∏—Ö—ñ–¥–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è –∫—Ä–æ–∫—É –¥–ª—è –ø–æ–¥–∞–ª—å—à–æ–≥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è
        echo "image_tag=$FULL_IMAGE_TAG" >> $GITHUB_OUTPUT
        
        echo "Prepared image tag: $FULL_IMAGE_TAG"

    # 5. –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è Node.js —Ç–∞ –∫–µ—à—É–≤–∞–Ω–Ω—è (–¥–ª—è —à–≤–∏–¥—à–æ—ó –∑–±—ñ—Ä–∫–∏)
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm' 

    # 6. –ó–±—ñ—Ä–∫–∞ —Ç–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –æ–±—Ä–∞–∑—É
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        # –û—Ç—Ä–∏–º—É—î–º–æ –≤–∏—Ö—ñ–¥–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è 'image_tag' –∑ –∫—Ä–æ–∫—É 'prepare_tag'
        tags: ${{ steps.prepare_tag.outputs.image_tag }}
